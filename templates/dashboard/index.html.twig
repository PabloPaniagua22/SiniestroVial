{% extends 'base.html.twig' %}

{% block title %}Dashboard de Reportes{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4 text-center">üìä Dashboard de Reportes</h1>

    <div class="text-center mb-4">
        <button class="btn btn-success me-2" id="exportExcel">üìó Exportar a Excel</button>
        <button class="btn btn-danger" id="exportPDF">üìï Exportar a PDF</button>
    </div>
    <div class="card p-3 mb-4 shadow-sm">
        <h5>Filtrar por Fecha</h5>
        <div class="row">
            <div class="col-md-4">
                <label>Desde:</label>
                <input type="date" id="fechaDesde" class="form-control">
            </div>

            <div class="col-md-4">
                <label>Hasta:</label>
                <input type="date" id="fechaHasta" class="form-control">
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="btnFiltrar">Filtrar</button>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Siniestros por Mes</h5>
                <canvas id="siniestrosMesChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Distribuci√≥n de Roles</h5>
                <canvas id="rolesChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Estado Alcoh√≥lico</h5>
                <canvas id="alcoholChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Tipos de Veh√≠culo</h5>
                <canvas id="vehiculosChart"></canvas>
            </div>
        </div>
    </div>
</div>

{# Librer√≠as #}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    /* VARIABLES GLOBALES*/

    let data = {};
    let charts = {}; // para destruir y recrear gr√°ficos din√°micamente

        /*FUNCI√ìN PRINCIPAL PARA CARGAR REPORTES*/
    async function cargarReportes() {
        try {
            const desde = document.getElementById("fechaDesde")?.value || "";
            const hasta = document.getElementById("fechaHasta")?.value || "";

            const query = new URLSearchParams();
            if (desde) query.append("desde", desde);
            if (hasta) query.append("hasta", hasta);

            const response = await fetch("/api/reportes?" + query.toString());
            data = await response.json();

            renderCharts();

        } catch (error) {
            console.error("Error cargando reportes:", error);
        }
    }

    /* INICIALIZAR AL CARGAR LA P√ÅGINA */
    document.addEventListener("DOMContentLoaded", cargarReportes);

    /*BOT√ìN FILTRAR POR FECHA */
    document.getElementById("btnFiltrar")?.addEventListener("click", cargarReportes);

    /* RENDERIZAR GR√ÅFICOS CON CHART.JS */
    function renderCharts() {

        // Si existen gr√°ficos previos ‚Üí destruirlos
        Object.values(charts).forEach(chart => chart.destroy());

        // Datos
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const siniestrosData = Array(12).fill(0);

        (data.siniestros || []).forEach(s => {
            if (s.mes) siniestrosData[s.mes - 1] = s.cantidad;
        });

        // Siniestros por mes 
        charts.siniestros = new Chart(document.getElementById("siniestrosMesChart"), {
            type: "bar",
            data: {
                labels: meses,
                datasets: [{
                    label: "Cantidad de Siniestros",
                    data: siniestrosData
                }]
            }
        });

        // Roles
        charts.roles = new Chart(document.getElementById("rolesChart"), {
            type: "pie",
            data: {
                labels: data.roles.map(r => r.rol),
                datasets: [{
                    data: data.roles.map(r => r.cantidad)
                }]
            }
        });

        // Estado alcoh√≥lico
        charts.alcohol = new Chart(document.getElementById("alcoholChart"), {
            type: "doughnut",
            data: {
                labels: data.alcohol.map(a => a.estado),
                datasets: [{
                    data: data.alcohol.map(a => a.cantidad)
                }]
            }
        });

        // Veh√≠culos 
        charts.vehiculos = new Chart(document.getElementById("vehiculosChart"), {
            type: "polarArea",
            data: {
                labels: data.vehiculos.map(v => v.tipo),
                datasets: [{
                    data: data.vehiculos.map(v => v.cantidad)
                }]
            }
        });
    }

    /* EXPORTAR A EXCEL CON FILTRO DE FECHA */
    document.getElementById("exportExcel").addEventListener("click", () => {
        try {
            if (!data.siniestros) throw new Error("No hay datos cargados");

            const fechaGen = new Date().toLocaleString("es-AR");
            const desde = document.getElementById("fechaDesde").value;
            const hasta = document.getElementById("fechaHasta").value;

            const rango = (desde && hasta) ? `${desde} ‚Üí ${hasta}` : "Sin filtro";

            const wb = XLSX.utils.book_new();

            // Hoja 1: siniestros
            const wsSiniestros = [
                ["Reporte de Siniestros Viales"],
                ["Generado:", fechaGen],
                ["Rango aplicado:", rango],
                [],
                ["Mes", "Cantidad"]
            ];

            data.siniestros.forEach(s => wsSiniestros.push([s.mes, s.cantidad]));

            const ws1 = XLSX.utils.aoa_to_sheet(wsSiniestros);
            XLSX.utils.book_append_sheet(wb, ws1, "Siniestros");

            // Roles
            const wsRoles = [["Rol", "Cantidad"]];
            data.roles.forEach(r => wsRoles.push([r.rol, r.cantidad]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsRoles), "Roles");

            // Alcohol
            const wsAlcohol = [["Estado", "Cantidad"]];
            data.alcohol.forEach(a => wsAlcohol.push([a.estado, a.cantidad]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsAlcohol), "Alcohol");

            // Veh√≠culos
            const wsVehiculos = [["Tipo", "Cantidad"]];
            data.vehiculos.forEach(v => wsVehiculos.push([v.tipo, v.cantidad]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsVehiculos), "Veh√≠culos");

            XLSX.writeFile(wb, "Reporte_Siniestros_Viales.xlsx");

        } catch (err) {
            alert("‚ö†Ô∏è Error al exportar: " + err.message);
        }
    });

    /* EXPORTAR A PDF CON FILTRO DE FECHA */
    document.getElementById("exportPDF").addEventListener("click", () => {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "pt", "a4");

            const fechaGen = new Date().toLocaleString("es-AR");
            const desde = document.getElementById("fechaDesde").value;
            const hasta = document.getElementById("fechaHasta").value;
            const rango = (desde && hasta) ? `${desde} ‚Üí ${hasta}` : "Sin filtro";

            pdf.setFontSize(18);
            pdf.text("Reporte de Siniestros Viales", 40, 50);

            pdf.setFontSize(12);
            pdf.text(`Generado: ${fechaGen}`, 40, 70);
            pdf.text(`Rango aplicado: ${rango}`, 40, 90);

            let y = 120;

            pdf.autoTable({
                startY: y,
                head: [["Mes", "Cantidad"]],
                body: data.siniestros.map(s => [s.mes, s.cantidad])
            });

            y = pdf.lastAutoTable.finalY + 20;

            pdf.autoTable({
                startY: y,
                head: [["Rol", "Cantidad"]],
                body: data.roles.map(r => [r.rol, r.cantidad])
            });

            y = pdf.lastAutoTable.finalY + 20;

            pdf.autoTable({
                startY: y,
                head: [["Estado", "Cantidad"]],
                body: data.alcohol.map(a => [a.estado, a.cantidad])
            });

            y = pdf.lastAutoTable.finalY + 20;

            pdf.autoTable({
                startY: y,
                head: [["Tipo", "Cantidad"]],
                body: data.vehiculos.map(v => [v.tipo, v.cantidad])
            });

            pdf.save("Reporte_Siniestros_Viales.pdf");

        } catch (err) {
            alert("‚ö†Ô∏è No se pudo exportar a PDF");
        }
    });
    
</script>

{% endblock %}
